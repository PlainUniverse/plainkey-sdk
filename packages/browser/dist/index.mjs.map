{"version":3,"file":"index.mjs","names":["errorData: ErrorResponse","credential: RegistrationResponseJSON","completeParams: RegistrationCompleteRequest","response: RegistrationCompleteResponse","completeParams: UserCredentialCompleteRequest","response: UserCredentialCompleteResponse","beginResponseData: LoginBeginResponse","authenticationResponse: AuthenticationResponseJSON","completeParams: LoginCompleteRequest","verificationResponseData: LoginCompleteResponse"],"sources":["../src/plainkey-client.ts"],"sourcesContent":["import { startAuthentication, startRegistration } from \"@simplewebauthn/browser\"\nimport { RegistrationResponseJSON, AuthenticationResponseJSON } from \"@simplewebauthn/browser\"\n\nimport type {\n  RegistrationBeginRequest,\n  RegistrationCompleteRequest,\n  UserCredentialBeginRequest,\n  UserCredentialCompleteRequest,\n  LoginBeginRequest,\n  LoginCompleteRequest\n} from \"@plainkey/types\"\n\nimport type {\n  RegistrationBeginResponse,\n  RegistrationCompleteResponse,\n  UserCredentialBeginResponse,\n  UserCredentialCompleteResponse,\n  LoginBeginResponse,\n  LoginCompleteResponse,\n  ErrorResponse\n} from \"@plainkey/types\"\n\nexport type PlainKeyClientParams = {\n  projectId: string\n  baseUrl?: string\n}\n\n// TODO: Account for errors like this: \"Unexpected token 'R', \"Response v\"... is not valid JSON\"\nexport class PlainKeyClient {\n  private readonly projectId: string\n  private readonly baseUrl: string\n\n  constructor(clientParams: PlainKeyClientParams) {\n    const { projectId, baseUrl = \"https://api.plainkey.io\" } = clientParams\n\n    this.projectId = projectId\n    this.baseUrl = baseUrl.replace(/\\/$/, \"\") // Remove trailing slash\n  }\n\n  /**\n   * Registration of a new user with passkey.\n   * Creates a new user and adds a credential to it.\n   */\n  async Registration(beginParams: RegistrationBeginRequest): Promise<RegistrationCompleteResponse> {\n    // Step 1: Get registration options from server\n    const headers = new Headers({\n      \"Content-Type\": \"application/json\",\n      \"x-project-id\": this.projectId\n    })\n\n    const beginResponse = await fetch(`${this.baseUrl}/user/register/begin`, {\n      method: \"POST\",\n      headers,\n      credentials: \"include\",\n      body: JSON.stringify(beginParams)\n    })\n\n    if (!beginResponse.ok) {\n      const errorData: ErrorResponse = await beginResponse.json()\n      throw new Error(errorData.error)\n    }\n\n    const { options, user } = (await beginResponse.json()) as RegistrationBeginResponse\n\n    // Step 2: Create credential using browser's WebAuthn API\n    const credential: RegistrationResponseJSON = await startRegistration({\n      optionsJSON: options\n    })\n\n    // Step 3: Send credential to server for verification\n    const completeParams: RegistrationCompleteRequest = {\n      userIdentifier: { userId: user.id },\n      credential\n    }\n\n    const completeResponse = await fetch(`${this.baseUrl}/user/register/complete`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"x-project-id\": this.projectId\n      },\n      credentials: \"include\",\n      body: JSON.stringify(completeParams)\n    })\n\n    if (!completeResponse.ok) {\n      const errorData: ErrorResponse = await completeResponse.json()\n      throw new Error(errorData.error)\n    }\n\n    // Intentionally not throwing errors on verification failure - UI should handle this.\n    const response: RegistrationCompleteResponse = await completeResponse.json()\n    if (!response) throw new Error(\"No registration response from server\")\n\n    return response\n  }\n\n  /**\n   * Add credential to existing user.\n   * Requires valid user authentication token (log user in first which will set a user token cookie, then call this).\n   */\n  async AddCredential(\n    beginParams: UserCredentialBeginRequest\n  ): Promise<UserCredentialCompleteResponse> {\n    // Step 1: Get credential registration options from server\n    const headers = new Headers({\n      \"Content-Type\": \"application/json\",\n      \"x-project-id\": this.projectId\n    })\n\n    const beginResponse = await fetch(`${this.baseUrl}/user/credential/begin`, {\n      method: \"POST\",\n      headers,\n      credentials: \"include\",\n      body: JSON.stringify(beginParams)\n    })\n\n    if (!beginResponse.ok) {\n      const errorData: ErrorResponse = await beginResponse.json()\n      throw new Error(errorData.error)\n    }\n\n    const { options, user } = (await beginResponse.json()) as UserCredentialBeginResponse\n\n    // Step 2: Create credential using browser's WebAuthn API\n    const credential: RegistrationResponseJSON = await startRegistration({\n      optionsJSON: options\n    })\n\n    // Step 3: Send credential to server for verification\n    const completeParams: UserCredentialCompleteRequest = {\n      userIdentifier: { userId: user.id },\n      credential\n    }\n\n    const completeResponse = await fetch(`${this.baseUrl}/user/credential/complete`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"x-project-id\": this.projectId\n      },\n      credentials: \"include\",\n      body: JSON.stringify(completeParams)\n    })\n\n    if (!completeResponse.ok) {\n      const errorData: ErrorResponse = await completeResponse.json()\n      throw new Error(errorData.error)\n    }\n\n    // Intentionally not throwing errors on verification failure - UI should handle this.\n    const response: UserCredentialCompleteResponse = await completeResponse.json()\n    if (!response) throw new Error(\"No credential registration response from server\")\n\n    return response\n  }\n\n  /**\n   * Performs a login ceremony.\n   */\n  async Login(beginParams: LoginBeginRequest): Promise<LoginCompleteResponse> {\n    // Step 1: Get authentication options from server\n    const beginResponse = await fetch(`${this.baseUrl}/login/begin`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"x-project-id\": this.projectId\n      },\n      credentials: \"include\",\n      body: JSON.stringify(beginParams)\n    })\n\n    if (!beginResponse.ok) {\n      const errorData: ErrorResponse = await beginResponse.json()\n      throw new Error(errorData.error)\n    }\n\n    const beginResponseData: LoginBeginResponse = await beginResponse.json()\n    if (!beginResponseData.options) {\n      throw new Error(\"No options found in login begin response\")\n    }\n\n    // Step 2: Pass options to the authenticator and wait for response\n    const authenticationResponse: AuthenticationResponseJSON = await startAuthentication({\n      optionsJSON: beginResponseData.options\n    })\n\n    if (!authenticationResponse) {\n      throw new Error(\"No authentication response from browser\")\n    }\n\n    // Step 3: POST the response to the server\n    const completeParams: LoginCompleteRequest = { authenticationResponse }\n\n    const verificationResponse = await fetch(`${this.baseUrl}/login/complete`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"x-project-id\": this.projectId\n      },\n      credentials: \"include\",\n      body: JSON.stringify(completeParams)\n    })\n\n    if (!verificationResponse.ok) {\n      const errorData: ErrorResponse = await verificationResponse.json()\n      throw new Error(errorData.error)\n    }\n\n    // Intentionally not throwing errors on verification failure - UI should handle this.\n    const verificationResponseData: LoginCompleteResponse = await verificationResponse.json()\n    if (!verificationResponseData) throw new Error(\"No login verification response from server\")\n\n    return verificationResponseData\n  }\n}\n"],"mappings":"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"}